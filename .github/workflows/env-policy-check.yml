name: Env policy check

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        # actions/checkout v6.0.1 (2025-12-02) pinned to commit SHA
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Enforce env file policy
        shell: bash
        run: |
          set -euo pipefail

          echo "== 1) No forbidden .env files tracked =="
          # Allowed public-safe env artifacts:
          #   .env.TEMPLATE  (documented template)
          #   .env.example   (lean example)
          #   .env.template  (legacy/optional allow)

          bad=""
          while IFS= read -r f; do
            b="$(basename "$f")"
            case "$b" in
              .env.example|.env.TEMPLATE|.env.template)
                ;;
              *)
                bad+="$f\n"
                ;;
            esac
          done < <(git ls-files -- '.env' '.env.*')

          if [[ -n "$bad" ]]; then
            echo "::error::Forbidden tracked env files detected:"
            printf "%b" "$bad"
            exit 1
          fi

          echo "== 2) .gitignore must ignore .env* but whitelist templates/examples =="
          test -f .gitignore || { echo "::error::.gitignore missing"; exit 1; }

          if grep -qE '^\s*\.env\*' .gitignore || grep -qE '^\s*\.env\.' .gitignore; then
            :
          else
            echo "::error::.gitignore must ignore .env* (or .env.*)"
            exit 1
          fi
          grep -qE '^\s*!\.env\.example' .gitignore || { echo "::error::.gitignore must whitelist .env.example"; exit 1; }
          # Accept either casing strategy, but require at least one whitelist:
          if ! grep -qE '^\s*!\.env\.TEMPLATE' .gitignore && ! grep -qE '^\s*!\.env\.template' .gitignore; then
            echo "::error::.gitignore must whitelist .env.TEMPLATE (or .env.template)"
            exit 1
          fi

          echo "== 3) Obvious token sanity check in public-safe files =="
          for f in .env.example .env.TEMPLATE .env.template; do
            [[ -f "$f" ]] || continue
            if grep -qE 'sk-[A-Za-z0-9]+' "$f"; then
              echo "::error::$f appears to contain an sk- token-like string"
              exit 1
            fi
          done

          echo "âœ… env policy OK"
