name: Enterprise CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ğŸš€ STAGE 1: Fast-fail quality gate (1-2 minutes)
  quality-gate:
    name: "Quality Gate - Lint/Type/Security"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
        cache: 'pip'
        cache-dependency-path: '**/requirements*.txt'

    - name: Install lint dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 mypy bandit safety

    - name: âœ¨ Code formatting checks (fail-fast)
      run: |
        echo "::group::Black formatting check"
        black --check --diff . > lint-black.txt 2>&1 || (echo "âŒ Code formatting issues found. Run 'make format' to fix." && exit 1)
        echo "::endgroup::"

        echo "::group::Import sorting check"
        isort --check-only --diff . > lint-isort.txt 2>&1 || (echo "âŒ Import sorting issues found. Run 'make format' to fix." && exit 1)
        echo "::endgroup::"

    - name: ğŸ” Linting checks (fail-fast)
      run: |
        echo "::group::Flake8 linting"
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics > lint-flake8.txt 2>&1
        flake8 . --count --max-complexity=10 --max-line-length=127 --statistics >> lint-flake8.txt 2>&1
        echo "::endgroup::"

    - name: ğŸ·ï¸ Type checking (fail-fast)
      run: |
        echo "::group::MyPy type checking"
        mypy . --strict --ignore-missing-imports > lint-mypy.txt 2>&1 || (echo "âŒ Type checking failed" && exit 1)
        echo "::endgroup::"

    - name: ğŸ”’ Security scanning
      run: |
        echo "::group::Bandit security scan"
        bandit -r . -x tests/ -ll -f json -o bandit-report.json
        echo "::endgroup::"

        echo "::group::Safety dependency check"
        safety check --json --output safety-report.json
        echo "::endgroup::"
      continue-on-error: true

    - name: ğŸ“Š Quality Gate Summary
      if: always()
      run: |
        echo "### ğŸš€ Quality Gate Results" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Black Formatting | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| Import Sorting | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| Flake8 Linting | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| MyPy Type Check | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | ğŸ” Complete |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ Behavior Contracts" >> $GITHUB_STEP_SUMMARY
        sed -n '12,20p' FUNCTION_CONTRACTS.md >> $GITHUB_STEP_SUMMARY

    - name: Upload quality artifacts
      # actions/upload-artifact v4 pinned to commit SHA (deprecates v3)
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
      if: always()
      with:
        name: quality-reports-${{ github.sha }}
        path: |
          lint-*.txt
          *-report.json
        retention-days: 30

  # ğŸ§ª STAGE 2: Core test matrix (3-5 minutes)
  unit-tests:
    name: "Unit Tests - Python ${{ matrix.python-version }}"
    runs-on: ubuntu-latest
    needs: quality-gate
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: '**/requirements*.txt'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install -e .

    - name: ğŸƒâ€â™‚ï¸ Run fast unit tests
      run: |
        echo "::group::Fast unit tests (not slow, not integration)"
        python -m pytest -x -m "not slow and not integration" \
          --cov=. --cov-report=xml --cov-report=term-missing \
          --tb=short --durations=10 --strict-markers -v \
          --cov-fail-under=70
        echo "::endgroup::"

    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: ./coverage.xml
        flags: unittests,py${{ matrix.python-version }}
        name: coverage-py${{ matrix.python-version }}
        fail_ci_if_error: false

    - name: ğŸ“Š Test Results Summary
      if: always()
      run: |
        echo "### ğŸ§ª Unit Test Results - Python ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
        echo "Coverage report: $(coverage report --show-missing | tail -1)" >> $GITHUB_STEP_SUMMARY
        echo "Test summary: $(pytest --collect-only -q | grep -c test) tests collected" >> $GITHUB_STEP_SUMMARY

    - name: Upload test artifacts
      # actions/upload-artifact v4 pinned to commit SHA (deprecates v3)
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
      if: always()
      with:
        name: test-results-py${{ matrix.python-version }}-${{ github.sha }}
        path: |
          coverage.xml
          coverage_html/
          .coverage
        retention-days: 7

  # ğŸ”„ STAGE 3: Integration & performance (5-10 minutes, conditional)
  integration-tests:
    name: "Integration & Performance Tests"
    runs-on: ubuntu-latest
    needs: [quality-gate, unit-tests]
    # Only run on main/develop pushes or PRs with 'full-test' label
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'full-test')

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
        cache: 'pip'
        cache-dependency-path: '**/requirements*.txt'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install -e .

    - name: ğŸŒ Run slow & integration tests
      run: |
        echo "::group::Slow and integration tests"
        python -m pytest -m "slow or integration" \
          --tb=line --durations=20 --strict-markers -v
        echo "::endgroup::"

    - name: ğŸ Run performance benchmarks
      run: |
        echo "::group::Performance benchmarks"
        python -m pytest -k benchmark \
          --benchmark-save=ci-${{ github.sha }} \
          --benchmark-json=benchmarks.json \
          --benchmark-sort=mean
        echo "::endgroup::"
      continue-on-error: true

    - name: ğŸ² Property-based testing
      run: |
        echo "::group::Property-based tests with Hypothesis"
        python -m pytest -m property \
          --tb=short --strict-markers -v \
          --hypothesis-show-statistics
        echo "::endgroup::"
      continue-on-error: true

    - name: Upload performance artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-results-${{ github.sha }}
        path: |
          .benchmarks/
          benchmarks.json
        retention-days: 30

  # ğŸš¢ OPTIONAL: Docker builds (triggered manually or on releases)
  docker-build:
    name: "Docker Images"
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker images
      run: |
        # Build whisper-local image if exists
        if [ -f "docker/whisper-local/Dockerfile" ]; then
          echo "ğŸ³ Building whisper-local image..."
          docker build -t whisper-local:latest docker/whisper-local/
        fi

        # Build faster-whisper image if exists
        if [ -f "docker/faster-whisper/Dockerfile" ]; then
          echo "ğŸ³ Building faster-whisper image..."
          docker build -t faster-whisper:latest docker/faster-whisper/
        fi

    - name: Test Docker images
      run: |
        # Smoke test that images run without error
        if docker images | grep -q whisper-local; then
          docker run --rm whisper-local:latest --help
        fi

        if docker images | grep -q faster-whisper; then
          docker run --rm faster-whisper:latest --help
        fi
